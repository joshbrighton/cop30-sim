<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>COP30 Simulation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: #f7f7f7;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .container {
      width: 90%;
      max-width: 650px;
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 10px;
      font-weight: 600;
    }

    p {
      font-size: 16px;
      margin-bottom: 30px;
      line-height: 1.5;
    }

    .mic {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      background: #004ea4;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0 auto;
      cursor: pointer;
      box-shadow: 0 0 0 0 rgba(0, 78, 164, 0.6);
      transition: transform 0.15s ease;
    }

    .mic svg {
      width: 40px;
      height: 40px;
      fill: white;
    }

    .mic.active {
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(0, 78, 164, 0.6); }
      70% { box-shadow: 0 0 0 18px rgba(0, 78, 164, 0); }
      100% { box-shadow: 0 0 0 0 rgba(0, 78, 164, 0); }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>COP30 Media Simulation</h1>
    <p>Click the microphone to begin. When the mic activates, say “Ok, I’m ready.”</p>

    <div class="mic" id="micButton">
      <svg viewBox="0 0 24 24">
        <path d="M12 14a3 3 0 0 0 3-3V5a3 3 0 0 0-6 0v6a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0h-2zm-5 7a9 9 0 0 0 9-9h-2a7 7 0 0 1-14 0H3a9 9 0 0 0 9 9zm-1 2v2h2v-2h-2z"/>
      </svg>
    </div>
  </div>

  <script>
    let audioContext;
    let micStream;
    let processor;
    let ws;

    async function startSimulation() {
      const micButton = document.getElementById("micButton");

      audioContext = new AudioContext();
      micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const source = audioContext.createMediaStreamSource(micStream);

      processor = audioContext.createScriptProcessor(4096, 1, 1);
      source.connect(processor);
      processor.connect(audioContext.destination);

      ws = new WebSocket("wss://cop30-sim.vercel.app/api/retell");

      ws.binaryType = "arraybuffer";

      processor.onaudioprocess = (e) => {
        if (ws.readyState === WebSocket.OPEN) {
          const input = e.inputBuffer.getChannelData(0);
          const int16 = new Int16Array(input.length);
          for (let i = 0; i < input.length; i++) {
            int16[i] = input[i] * 32767;
          }
          ws.send(int16);
        }
      };

      ws.onmessage = (message) => {
        playAudio(new Int16Array(message.data));
      };

      micButton.classList.add("active");
    }

    function playAudio(int16) {
      const float32 = new Float32Array(int16.length);
      for (let i = 0; i < int16.length; i++) {
        float32[i] = int16[i] / 32767;
      }
      const buffer = audioContext.createBuffer(1, float32.length, audioContext.sampleRate);
      buffer.getChannelData(0).set(float32);

      const source = audioContext.createBufferSource();
      source.buffer = buffer;
      source.connect(audioContext.destination);
      source.start();
    }

    document.getElementById("micButton").onclick = startSimulation;
  </script>
</body>
</html>

